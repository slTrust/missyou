### 4-1 权限、分组与用户的关系探讨

> 权限

- API对于用户来说可不可以访问
- C端 用户 不同会员等级享受不同待遇
- CMS 动态权限组

> 分组(角色)

- 不同身份(角色)的用户可不可以访问

> #### 建议：

- 用户不和权限有关系
- 分组才和 权限有关系
- 用户必须属于一个分组

### 4-2 @ScopeLevel注解的机制

> 通过不同注解 针对一个url 设置权限

- @Admin 代表管理员
- @Vip
- @User

```

@Admin
@Vip
@User
@GetMapping("/name/{name}/with_spu")
public Theme getThemeByNameWithSpu(){ ... }
```

缺陷：

- 如果有很多接口 每个地方都要添加这个注解 管理起来非常麻烦

> @ScopeLevel

- 通过权值 来区分访问
    - VIP ==》 16
    - User ==> 8

```
@ScopeLevel(8)
@GetMapping("/name/{name}/with_spu")
public Theme getThemeByNameWithSpu(){ ... }
```

### 4-3 令牌与微信登录机制

> 001 用户登录

- 账号 / 密码
    - 自定义字符串 昵称 
    - 邮箱，手机
    - 验证码
    
> 微信登录

- 账号密码 静默登录
- 手机号 注册

> 小程序登录(第三方登录)

- 由微信 母体 验证了账号密码
- 登录流程：code 通过把它 发送到 我们的API =》 微信服务器

> 票据

cookie / token 一段时间内免登录

> 令牌JWT

- 随机字符串 Redis 缓存 -> uid
- 现在前后端分离的程序
    - 令牌的方式 JWT 

### 4-4 无感知二次登陆问题探讨

- 令牌到期后，原则上要重新登录 获取新的 JWT令牌

> 一个场景分析

- JWT假设7天
- 在 JWT第6天23小时59分 登录了，此时你是有令牌的而且没过期
    - 2分钟后 令牌失效了，如果是前端项目可能就是把用户踢掉 重新输入账号密码

- 不推荐方式JWT
    - JWT 有效期 1个月 1年？ 这个是不安全的
- JWT有效期不能太长 建议 2小时

> JWT写入信息 

- UID 用户信息
- IP 信息 
    - 每次登录存入一个 IP地址
    - 验证 IP合法性
    - 建立一个 用户常用IP地址表，比如 QQ的异地登陆(换了设备，非常用地登录)

> #### 对于微信小程序来说

- 无感知二次登录问题是不存在的
- 如果是网站，想实现无感知二次登录
    - 一个 JWT可能不够，
    - 可以双令牌 access_token  refresh_token